[#application]
= Deploy a Multicluster Application with GitOps

`OpenShift GitOps` implements `Argo CD` as a controller so that it continuously monitors application definitions and configurations defined in a Git repository. Then, `Argo CD` compares the specified state of these configurations with their live state on the cluster.

The `ApplicationSet` leverages the cluster decision generator to interface Kubernetes custom resources that use custom resource-specific logic to decide which managed clusters to deploy to. A cluster decision resource generates a list of managed clusters, which are then rendered into the template fields of the ApplicationSet resource. This is done using duck-typing, which does not require knowledge of the full shape of the referenced Kubernetes resource.

`ApplicationSet` is a sub-project of `Argo CD` that adds multicluster support. You will go through this section to create ApplicationSets from the Red Hat Advanced Cluster Management.

Next both sections, from ACM or CLI will deploy the same application.

[#applicationacm]
== Creating an Argo CD application from ACM

An ArgoCD application can be created in ACM from the UI Console as follow:

Go throught the ACM Console and login with Openshift user:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc get route -n open-cluster-management
----

**>> Applications >> Create Application > ApplicationSet**

image::application/application02.png[]

**>> General**

* ApplicationSet name: rhte2023-application
* Argo server: openshift-gitops
* Requeue time: 180

image::application/application03.png[]

**>> Template**

* URL: https://github.com/xbryan1/rhte-2023-acm-apps.git
* Revision: main
* Path: rhte2023/04_deploy_applications/rhte2023-application
* Remote Namespace: rhte2023-application

image::application/application04.png[]

**>> Sync policy**

image::application/application05.png[]

**>> Placement**

* Cluster sets: rhte2023-gitops-clusters

image::application/application06.png[]

**>> Review and Submit**

image::application/application07.png[]

**>> Wait until application is deployed, and check the application topoloy**

image::application/application08.png[]

**>> Check from the Argo CD Web UI the application status**

image::application/application09.png[]

** >> Check Application pods on one of the cluster**

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc get pod,route -n rhte2023-application
----

[#applicationcli]
== Creating an Argo CD application from CLI

* **Login into the ArgoCD instance**:

Get ArgoCD route exposed in `openshift-gitops` namespace

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc get route openshift-gitops-server -n openshift-gitops
----

Get the ArgoCD admin password from the secret `openshift-gitops-cluster` in `openshift-gitops` namespace

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc get secret/openshift-gitops-cluster -n openshift-gitops -o jsonpath='{.data.admin\.password}' | base64 -d
----

Login into the ArgoCD instance on the ACM Openshift Cluster:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
argocd --insecure --grpc-web login <your_argocd:route> --username admin --password <your_password>
----


* **Create an ArgoCD Application**:

Run the following command to create a `rhte2023-application-gitops` which will create an `ApplicationSet` to deploy the application across 2 Openshift Clusters
[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
argocd app create rhte2023-application-gitops \
--project default \
--repo https://github.com/xbryan1/rhte-2023-acm-apps.git \
--path rhte2023/04_deploy_applications/argocd \
--dest-namespace openshift-gitops 
----

* **Get ArgoCD Application details**:

In order to check the deployment status run:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
argocd app list
----

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
argocd app get rhte2023-application-gitops
----

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
argocd app get rhte2023-application-local-cluster
argocd app history rhte2023-application-local-cluster
----

At the same time, check the CRDs created:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc get Application,ApplicationSet -n openshift-gitops
----

- **Check the Application and ApplicationSet created**

The ArgoCD application will create the 'ApplicationSet' on ACM/ArgoCD which will deploy the application.

- ArgoCD Applications view

image::application/application10.png[]

- ACM discover ArgoCD Applications

image::application/application11.png[]

- ArgoCD GitOps Application will be created and the application will be deployed

image::application/application12.png[]
image::application/application13.png[]

`ApplicationSet` CRD uses https://argocd-applicationset.readthedocs.io/en/stable/Generators-Cluster-Decision-Resource/[clusterDecisionResource] generator to generate a list of Openshift clusters where deploy the Application. Take a look at the YAML file

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
cd /rhte2023/04_deploy_applications/argocd; cat rhte2023-application.yaml
----

[.lines_space]
[.console-input]
[source,yaml, subs="+macros,+attributes"]
----
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: rhte2023-application
  namespace: openshift-gitops
spec:
  generators:
  - clusterDecisionResource:
      configMapRef: acm-placement
      labelSelector:
        matchLabels:
          cluster.open-cluster-management.io/placement: rhte2023-gitops-clusters
      requeueAfterSeconds: 180
  template:
    metadata:
      labels:
        velero.io/exclude-from-backup: "true"
      name: rhte2023-application-{{name}}
    spec:
      destination:
        namespace: rhte2023-application
        server: '{{server}}'
      project: default
      source:
        path: rhte2023/04_deploy_applications/rhte2023-application
        repoURL: https://github.com/xbryan1/rhte-2023-acm-apps.git
        targetRevision: main
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
        - CreateNamespace=true
        - PruneLast=true
----

[#applicationsync]
== Syncing an ArgoCD Application

Syncing in ArgoCD means matching the state described in `Git` and what is in the Openshift cluster. By default, Argo CD will auto-sync applications with the following `SyncPolocies` for an `ApplicationSet` every 3 minutes:

* Automatically sync when cluster state changes (syncPolicy/automated/selfHeal=true)
* Delete resources that are no longer defined in the source repository (syncPolicy/automated/prune=true)
* Delete resources that are no longer defined in the source repository at the end of a sync operation (syncOptions/CreateNamespace=true)
* Automatically create namespace if it does not exist (syncOptions/CreateNamespace=true)

There's additional options to configure the `ApplicationSet`:

* Replace resources instead of applying changes from the source repository (syncOptions/Replace=false)
* Allow applications to have empty resources (syncPolicy/automated/allowEmpty=false)
* Only synchronize out-of-sync resources (syncOptions/ApplyOutOfSyncOnly=false)
* Disable kubectl validation (syncOptions/Validate=false)
* Prune propagation policy (syncOptions/PrunePropagationPolicy=background)

By default:

[.lines_space]
[.console-input]
[source,yaml, subs="+macros,+attributes"]
----
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: rhte2023-application
  namespace: openshift-gitops
spec:
...
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
        - CreateNamespace=true
        - PruneLast=true
----

Once the before applications is deployed, change the application as shown below and sync in the ArgoCD Console the changes manually:

- Change application replicas

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc scale deploy rhte2023-application --replicas=1
----

image::application/application14.png[]

After a while, application will scale automatically to the initial number of replicas (3)

- Commit a change on the deployment yaml file

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
cd rhte2023/04_deploy_applications/rhte2023-application/base
sed -i 's/replicas: 3/replicas: 5/g' 100-deployment.yaml
git add 100-deployment.yaml
git commit -m "incresing number of replicas"
git push origin main
----

Once the change has been pushed, sync the application again.

ArgoCD Console

image::application/application15.png[]

ACM Topology

image::application/application16.png[]

NOTE:
====
Also, you can sync applications going through the argocd cli as follows:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
argocd app sync rhte2023-application-gitops
----
====