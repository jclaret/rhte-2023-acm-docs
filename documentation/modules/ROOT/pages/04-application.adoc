[#application]
= Deploy a Multicluster Application with GitOps

`OpenShift GitOps` implements `Argo CD` as a controller so that it continuously monitors application definitions and configurations defined in a Git repository. Then, `Argo CD` compares the specified state of these configurations with their live state on the cluster.

The `ApplicationSet` leverages the cluster decision generator to interface Kubernetes custom resources that use custom resource-specific logic to decide which managed clusters to deploy to. A cluster decision resource generates a list of managed clusters, which are then rendered into the template fields of the ApplicationSet resource. This is done using duck-typing, which does not require knowledge of the full shape of the referenced Kubernetes resource.

`ApplicationSet` is a sub-project of `Argo CD` that adds multicluster support. You will go through this section to create ApplicationSets from the Red Hat Advanced Cluster Management.

We are gonna deploy some applications to understand the how it works.

[#applicationacm01]
== Application 1 - Deploying a ChatBot application

The first Application will be created from the Advanced Cluster Management console and it will be deployed on those Clusters matching **Vendor=Openshift** and **Platform=AWS** labels.

Go throught the Advanced Cluster Management Console and login with Openshift user:

**>> Applications >> Create Application > ApplicationSet**

image::application/application02.png[]

**>> General**

* ApplicationSet name: rhte2023-application-01
* Argo server: openshift-gitops
* Requeue time: 180

image::application/application03.png[]

**>> Template**

* URL: https://github.com/xbryan1/rhte-2023-acm-apps.git
* Revision: main
* Path: rhte2023/04_deploy_applications/rhte2023-application-01
* Remote Namespace: rhte2023-application-01

image::application/application04.png[]

**>> Sync policy**

image::application/application05.png[]

**>> Placement**

* Cluster sets: rhte2023-gitops-clusters

image::application/application06.png[]

**>> Review and Submit**

image::application/application07.png[]

**>> Wait until application is deployed, and check the application topoloy**

image::application/application08.png[]

**>> Check from the Argo CD Web UI the application status**

image::application/application09.png[]

** >> Check Application pods on both clusters**

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc --context acm get pod,route -n rhte2023-application-01
----

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc --context cluster01 get pod,route -n rhte2023-application-01
----

[#applicationreplicas]
== Application 1 - Change number of replicas

Once the `rhte2023-application-01` is already deployed, let's change the application replicas:

- Change application replicas

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc --context acm scale deploy rhte2023-application-01 --replicas=1
----

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc --context get pod -n rhte2023-application-01
----

After a while, application will scale automatically to the initial number of replicas (5).

- Make a change on the deployment yaml file

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
cd rhte2023/04_deploy_applications/rhte2023-application-01/base
sed -i 's/replicas: 5/replicas: 3/g' 100-deployment.yaml
git add 100-deployment.yaml
git commit -m "decreasing number of replicas"
git push origin main
----

Once the change has been pushed, sync the application again.

ArgoCD Console

image::application/application15.png[]

ACM Topology

image::application/application16.png[]

[#applicationacm02]
== Application 2 - Deploying a ChatDraw application

The second Application will be created from the Advanced Cluster Management console and it will be deployed on those Clusters matching **Version=4.10.x** and **Environment=Development** labels. The Openshift Version value is filled automatically, but we need to label the **Development" clusters as follows:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc --context acm label ManagedCluster rhte2023-cluster01 Environment=Development --overwrite
----

Once labeled, let's go throught the Advanced Cluster Management Console and create the second application.

**>> Applications >> Create Application > ApplicationSet**

**>> General**

* ApplicationSet name: rhte2023-application-02
* Argo server: openshift-gitops
* Requeue time: 180

**>> Template**

* URL: https://github.com/xbryan1/rhte-2023-acm-apps.git
* Revision: main
* Path: rhte2023/04_deploy_applications/rhte2023-application-02
* Remote Namespace: rhte2023-application-02

**>> Sync policy**

**>> Placement**

* Cluster sets: rhte2023-gitops-clusters

**>> Review and Submit**

**>> Wait until application is deployed, and check the application topoloy**

**>> Check from the Argo CD Web UI the application status**

**>> Check Application pods on both clusters**

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc --context acm get pod,route -n rhte2023-application-02
----

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc --context cluster01 get pod,route -n rhte2023-application-02
----

[#applicationimages]
== Application 2 - Change container image

Once the `rhte2023-application-02` is already deployed, let's change the application image:

- Change application image commit and push your changes.

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
cd rhte2023/04_deploy_applications/rhte2023-application-02/base
sed -i 's/chatdraw:latest/chatdraw:rhte2023/g' 100-deployment.yaml
git add 100-deployment.yaml
git commit -m "changing the application image"
git push origin main
----

Once the change has been pushed, sync the application again and verify that the application has been changed (background color)

[#applicationacm03]
== Application - Deploying multiple Applications

The third and fourth Applications will be created from the ArgoCD command line and it will be deployed on those Clusters 

- matching **Location=eu-west-2** and **Area=Fringe** labels
- selecting a cluster with the largest allocatable CPU and memory.

Let's label the **Area" cluster as follows:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc --context acm label ManagedCluster rhte2023-cluster01 Area=Fringe --overwrite
----

Once labeled, let's go through the ArgoCD CLI commands to create both applications.

* **Change repository**:

Check the following directory and change the `repoURL` for your repository in `rhte2023-application-03.yaml` and `rhte2023-application-04.yaml` files before create the Application.:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
cd rhte2023/04_deploy_applications/argocd
----

* **Create an ArgoCD Application**:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
argocd app create rhte2023-application-gitops \
--project default \
--repo https://github.com/xbryan1/rhte-2023-acm-apps.git \
--path rhte2023/04_deploy_applications/argocd \
--dest-namespace openshift-gitops
--dest-server https://api.<your_domain>:6443
----

* **Get ArgoCD Application details**:

In order to check the deployment status run:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
argocd app list
----

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
argocd app get rhte2023-application-gitops
----

- **Check the Application and ApplicationSet created**

The ArgoCD application will create the 'ApplicationSet' on ACM/ArgoCD which will deploy the application.

- Check Application pods

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc --context cluster01 get pod,route -n rhte2023-application-03
----


[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc --context cluster01 get pod,route -n rhte2023-application-04
----

- ArgoCD Applications view

- ACM discover ArgoCD Applications

[#applicationimages]
== Application - Sync and Diff

The third Application is deployed with an **HPA - horizontal pod autoscaler** that let you specify the minimum and maximum number of pods you want to run. It means that this application will change the number of replicas and it will not match what is defined in Git repository. As a conclusion the ArgoCD the application will be **out of sync**.

- Check and Sync the Application from the ArgoCD UI

- Solve the issue removing the replica definition as follows:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
cd rhte2023/04_deploy_applications/rhte2023-application-03/base
sed -i 's/replicas://d' 100-deployment.yaml
git add 100-deployment.yaml
git commit -m "removing the replicas definition"
git push origin main
----

Commit and push your changes. 

- Sync and Refresh again.

NOTE: This issue could be solved adding https://argo-cd.readthedocs.io/en/stable/user-guide/diffing/#application-level-configuration[ignoreDifferences] into the deployment definition.