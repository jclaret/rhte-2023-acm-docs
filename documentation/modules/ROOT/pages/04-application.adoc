[#application]
= Deploy a Multicluster Application with GitOps

`OpenShift GitOps` implements `Argo CD` as a controller so that it continuously monitors application definitions and configurations defined in a Git repository. Then, `Argo CD` compares the specified state of these configurations with their live state on the cluster.

The `ApplicationSet` leverages the cluster decision generator to interface Kubernetes custom resources that use custom resource-specific logic to decide which managed clusters to deploy to. A cluster decision resource generates a list of managed clusters, which are then rendered into the template fields of the ApplicationSet resource. This is done using duck-typing, which does not require knowledge of the full shape of the referenced Kubernetes resource.

`ApplicationSet` is a sub-project of `Argo CD` that adds multicluster support. You will go through this section to create ApplicationSets from the Red Hat Advanced Cluster Management and from the ArgoCD CLI.

We are gonna deploy some applications to understand the how it works.

[#applicationacm01]
== Application 1 - Deploying a ChatBot application

The first Application will be created from the Advanced Cluster Management console and it will be placed on those Clusters matching labels:

* **Vendor=Openshift** 
* **Platform=AWS**

Go throught the Advanced Cluster Management Console and login with Openshift user:

**Advanced Cluster Management Console > Applications > Create Application > ApplicationSet**

image::application/application02.png[]

**Advanced Cluster Management Console > Applications > Create Application > ApplicationSet > General**

* **ApplicationSet name**: rhte2023-application-01
* **Argo server**: openshift-gitops
* **Requeue time**: 180

image::application/application03.png[]

**Advanced Cluster Management Console > Applications > Create Application > ApplicationSet > Template**

* **URL**: https://github.com/<your_github_account>/rhte-2023-acm-apps.git
* **Revision**: main
* **Path**: rhte2023/04_deploy_applications/rhte2023-application-01
* **Remote Namespace**: rhte2023-application-01

image::application/application04.png[]

**Advanced Cluster Management Console > Applications > Create Application > ApplicationSet > Sync policy**

* **Automatically sync when cluster state changes** (syncPolicy/automated/selfHeal=true)
* **Delete resources that are no longer defined in the source repository* (syncPolicy/automated/prune=true)
* **Delete resources that are no longer defined in the source repository at the end of a sync operation** (syncOptions/CreateNamespace=true)
* **Automatically create namespace if it does not exist** (syncOptions/CreateNamespace=true)

image::application/application05.png[]

**Advanced Cluster Management Console > Applications > Create Application > ApplicationSet > Placement**

* Placement: rhte2023-gitops-clusters

image::application/application06.png[]

**Advanced Cluster Management Console > Applications > Create Application > ApplicationSet > Review and Submit**

image::application/application07.png[]

**Advanced Cluster Management Console > Applications > rhte2023-application-01 (filter by ApplicationSet) > Topology**

image::application/application08.png[]

**Advanced Cluster Management Console > Applications > Advanced Configuration > Placements**

Check the number of cluster matching with **Placement > rhte2023-gitops-clusters**, so we expect deploy the Application **rhte2023-application-01** in all of them.

image::application/application08b.png[]

Also, let's check from the ArgoCD Console what is the Application status:

**Argo CD Console > Applications**

image::application/application09.png[]

Also, let's check the Application deployment pods on both clusters.

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc --context acm get pod -n rhte2023-application-01
----

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc --context cluster01 get pod -n rhte2023-application-01
----

Finally, let's check how is the Application deployed:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc --context acm get route -n rhte2023-application-01
----

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc --context cluster01 get route -n rhte2023-application-01
----

image::application/application09b.png[]

This is a GPT3 Chatbot, so just make questions on the chat to get bot's answers.

[#applicationreplicas]
== Application 1 - Change number of replicas

In order to check how ArgoCD and ACM are monitoring the Application, let's make changes and see what happens.

- **Change application replicas**

Let's change the number of replicas in both clusters and check how it is fixed automatically.

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc --context acm scale deployment/rhte2023-application-01 -n rhte2023-application-01 --replicas=0
oc --context cluster01 scale deployment/rhte2023-application-01 -n rhte2023-application-01 --replicas=0
----

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc --context acm get pod -n rhte2023-application-01
oc --context cluster01 get pod -n rhte2023-application-01
----

After a while, application will scale automatically to the initial number of replicas (5).

image::application/application09c.png[]

- **Make a change on the deployment yaml file**

Now, let's make a persistent changes on the Git repository:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
cd rhte2023/04_deploy_applications/rhte2023-application-01/base
sed -i 's/replicas: 5/replicas: 3/g' 100-deployment.yaml
git add 100-deployment.yaml
git commit -m "decreasing number of replicas"
git push origin main
----

TIP: See how configure a token GitHub https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token[Creating a personal access token]

Once the change has been pushed, sync the application again.

image::application/application09c.png[]

ArgoCD Console

image::application/application15.png[]

Great job man!!

[#applicationacm02]
== Application 2 - Deploying a ChatDraw application

The second Application will be created from the Advanced Cluster Management console and it will be deployed on those Clusters matching **environment=development** label. The Openshift Version value is filled automatically, but we need to label the **development" clusters as follows:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc --context acm label ManagedCluster rhte2023-cluster01 environment=development --overwrite
----

Once labeled, let's go throught the Advanced Cluster Management Console and create the second application.

**>> Applications >> Create Application > ApplicationSet**

**>> General**

* ApplicationSet name: rhte2023-application-02
* Argo server: openshift-gitops
* Requeue time: 180

**>> Template**

* URL: https://github.com/xbryan1/rhte-2023-acm-apps.git
* Revision: main
* Path: rhte2023/04_deploy_applications/rhte2023-application-02
* Remote Namespace: rhte2023-application-02

**>> Sync policy**

**>> ClusterSet and Placement**

* Cluster sets: rhte2023-gitops-clusters
* Placement: rhte2023-gitops-clusters-environment

**>> Review and Submit**

**>> Wait until application is deployed, and check the application topoloy**

**>> Check from the Argo CD Web UI the application status**

**>> Check Application pods on both clusters**

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc --context acm get pod,route -n rhte2023-application-02
----

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc --context cluster01 get pod,route -n rhte2023-application-02
----

[#applicationimages]
== Application 2 - Change container image

Once the `rhte2023-application-02` is already deployed, let's change the application image:

- Change application image commit and push your changes.

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
cd rhte2023/04_deploy_applications/rhte2023-application-02/base
sed -i 's/chatdraw:latest/chatdraw:rhte2023/g' 100-deployment.yaml
git add 100-deployment.yaml
git commit -m "changing the application image"
git push origin main
----

Once the change has been pushed, sync the application again and verify that the application has been changed (background color)

[#applicationacm03]
== Application - Deploying multiple Applications

The third and fourth Applications will be created from the ArgoCD command line and it will be deployed on those Clusters 

- matching **Location=eu-west-2** and **Area=Fringe** labels
- selecting a cluster with the largest allocatable CPU and memory.

Let's label the **Area** cluster as follows:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc --context acm label ManagedCluster rhte2023-cluster01 area=fringe --overwrite
----

Once labeled, let's go through the ArgoCD CLI commands to create both applications.

* **Change repository**:

Check the following directory and change the `repoURL` for your repository in `rhte2023-application-03.yaml` and `rhte2023-application-04.yaml` files before create the Application.:

* **Get ArgoCD Credentials**

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc get secret/openshift-gitops-cluster -n openshift-gitops -o jsonpath='{.data.admin\.password}' | base64 -d
----

* **Get ArgoCD Route**

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc get route -n openshift-gitops
----

* **Login into ArgoCD**

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
argocd login openshift-gitops-server-openshift-gitops.apps.<your_domain> --username admin --password <your_password>--insecure
----

* **List ArgoCD Clusters**

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
argocd cluster list
----

* **Create an ArgoCD Application**:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
argocd app create rhte2023-application-gitops \
--project default \
--repo <your_forked_repository> \
--path rhte2023/04_deploy_applications/argocd \
--sync-policy automated \
--dest-namespace openshift-gitops \
--dest-server https://api.<your_domain>:6443

----

* **Get ArgoCD Application details**:

In order to check the deployment status run:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
argocd app list
----

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
argocd app get rhte2023-application-gitops
----

- Check Application pods

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc --context cluster01 get pod,route -n rhte2023-application-03
----

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc --context cluster01 get pod,route -n rhte2023-application-04
----

- Check Application route

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc --context cluster01 get route -n rhte2023-application-03
----

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc --context cluster01 get route -n rhte2023-application-04
----

- ArgoCD Applications view

- ACM discover ArgoCD Applications

[#applicationimages]
== Application - Sync and Diff

The third Application is deployed with an **HPA - horizontal pod autoscaler** that let you specify the minimum and maximum number of pods you want to run. It means that this application will change the number of replicas and it will not match what is defined in Git repository. As a conclusion the ArgoCD the application will be **out of sync**.

- Check and Sync the Application from the ArgoCD UI

- Solve the issue removing the replica definition as follows:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
cd rhte2023/04_deploy_applications/rhte2023-application-03/base
sed -i 's/replicas://d' 100-deployment.yaml
git add 100-deployment.yaml
git commit -m "removing the replicas definition"
git push origin main
----

Commit and push your changes. 

- Sync and Refresh again.

NOTE: This issue could be solved adding https://argo-cd.readthedocs.io/en/stable/user-guide/diffing/#application-level-configuration[ignoreDifferences] into the deployment definition.